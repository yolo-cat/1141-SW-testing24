# PlayByPlayAnnouncer 重構說明

## 重構目標
提升 `announceInning()` 方法的可測試性，將業務邏輯與輸出邏輯分離。

---

## 重構內容

### 1. 新增 `InningSummary` 類別
封裝一局比賽的統計結果：

```java
public class InningSummary {
    private final int runs;      // 得分
    private final int hits;      // 安打數
    private final int outs;      // 出局數
    private final int lob;       // 殘壘數
    private final List<Boolean> finalBases;  // 最終壘包狀態
    
    // Getters...
    public int getRuns() { return runs; }
    public int getHits() { return hits; }
    public int getOuts() { return outs; }
    public int getLob() { return lob; }
    public String getBaseStateDesc() { ... }
}
```

### 2. 新增 `getInningSummary()` 方法
純粹的業務邏輯，可測試：

```java
public static InningSummary getInningSummary(String[] events) {
    resetState();
    
    for (String event : events) {
        processEvent(event);  // 處理事件，不包含輸出
    }
    
    return new InningSummary(runs, hits, outs, calculateLOB(), bases);
}
```

### 3. 新增 `show()` 方法
純粹的輸出邏輯：

```java
public static void show(InningSummary summary) {
    System.out.println("==========================================");
    System.out.println("               本局總結報告               ");
    System.out.println("==========================================");
    System.out.printf("最終得分 (R)：%d\n", summary.getRuns());
    System.out.printf("總安打數 (H)：%d\n", summary.getHits());
    System.out.printf("最終出局數 (O)：%d\n", summary.getOuts());
    System.out.printf("殘壘數 (LOB)：%d (%s)\n", summary.getLob(), summary.getBaseStateDesc());
    System.out.println("==========================================");
}
```

### 4. 保留 `announceInning()` 方法（向後相容）
原有的方法仍然可用，內部使用新的架構。

---

## 使用方式

### 方式 1: 使用 `getInningSummary()` 進行測試

```java
@Test
void testGetInningSummary_t01() {
    // Arrange
    String[] events = {"BB", "1B", "K", "2B 1R", "F8", "6-3"};
    
    // Act
    InningSummary summary = PlayByPlayAnnouncer.getInningSummary(events);
    
    // Assert
    assertEquals(1, summary.getRuns(), "得分數不符");
    assertEquals(2, summary.getHits(), "安打數不符");
    assertEquals(3, summary.getOuts(), "出局數不符");
    assertEquals(2, summary.getLob(), "殘壘數不符");
}
```

### 方式 2: 使用 `show()` 顯示結果

```java
String[] events = {"BB", "1B", "K", "2B 1R", "F8", "6-3"};
InningSummary summary = PlayByPlayAnnouncer.getInningSummary(events);
PlayByPlayAnnouncer.show(summary);
```

輸出：
```
==========================================
               本局總結報告               
==========================================
最終得分 (R)：1
總安打數 (H)：2
最終出局數 (O)：3
殘壘數 (LOB)：2 (三壘、二壘有人)
==========================================
```

### 方式 3: 使用原本的 `announceInning()`（向後相容）

```java
String[] events = {"BB", "1B", "K", "2B 1R", "F8", "6-3"};
PlayByPlayAnnouncer.announceInning(events);
```

這會顯示完整的逐打席播報和總結。

---

## 測試案例

### Test Case 1: 正常流程
```java
String[] events = {"BB", "1B", "K", "2B 1R", "F8", "6-3"};
InningSummary summary = PlayByPlayAnnouncer.getInningSummary(events);

assertEquals(1, summary.getRuns());
assertEquals(2, summary.getHits());
assertEquals(3, summary.getOuts());
assertEquals(2, summary.getLob());
```

### Test Case 2: 3 Out 後的錯誤
```java
String[] events = {"K", "K", "K", "1B"};

assertThrows(ScoringException.class, 
    () -> PlayByPlayAnnouncer.getInningSummary(events));
```

### Test Case 3: 無效代碼
```java
String[] events = {"BB", "K", "3B 1R", "WTF", "HR 3R"};

assertThrows(ScoringException.class, 
    () -> PlayByPlayAnnouncer.getInningSummary(events));
```

### Test Case 4: 複雜壘包狀態
```java
String[] events = {"BB", "BB", "BB", "BB 1R", "2B 2R", "K", "BB", "K"};
InningSummary summary = PlayByPlayAnnouncer.getInningSummary(events);

assertEquals(3, summary.getRuns());
assertEquals(1, summary.getHits());
assertEquals(2, summary.getOuts());
assertEquals(3, summary.getLob());
```

---

## 重構優點

### ✅ 可測試性
- 可以直接驗證計算結果
- 不需要捕捉控制台輸出
- 測試執行快速且乾淨

### ✅ 單一職責原則
- `getInningSummary()`: 業務邏輯
- `show()`: 輸出邏輯
- `processEvent()`: 事件處理
- 各司其職，易於維護

### ✅ 可重用性
- `InningSummary` 可以用於其他用途（統計、比較、序列化）
- 可以輕鬆改變輸出格式（JSON、XML、GUI）
- 可以在不同的上下文中使用相同的業務邏輯

### ✅ 向後相容
- 保留原本的 `announceInning()` 方法
- 現有代碼不需要修改
- 可以逐步遷移到新的 API

---

## 測試結果

```
[INFO] Running xdemo.InningSummaryTest
✓ t01 測試結果: InningSummary{runs=1, hits=2, outs=3, lob=2, bases=三壘、二壘有人}
✓ t02 測試結果: 成功捕捉例外 - 速記錯誤：局數已達 3 Out，但仍有事件 '1B' 發生。
✓ t03 測試結果: 成功捕捉例外 - 無法解析的速記代碼: 'WTF'，來自打者: Will Smith
✓ t04 測試結果: InningSummary{runs=3, hits=1, outs=2, lob=3, bases=三壘、二壘、一壘有人}
✓ 全壘打測試結果: InningSummary{runs=3, hits=2, outs=1, lob=0, bases=無人在壘}
✓ 空事件測試結果: InningSummary{runs=0, hits=0, outs=0, lob=0, bases=無人在壘}
✓ 只有出局測試結果: InningSummary{runs=0, hits=0, outs=3, lob=0, bases=無人在壘}

Tests run: 7, Failures: 0, Errors: 0, Skipped: 0
```

---

## 檔案結構

```
src/
├── main/java/xdemo/
│   ├── PlayByPlayAnnouncer.java  (重構後)
│   └── InningSummary.java        (新增)
└── test/java/xdemo/
    ├── PlayByPlayAnnouncerTest.java  (extractRuns 測試)
    └── InningSummaryTest.java        (新增，getInningSummary 測試)
```

---

## 總結

這次重構成功地將業務邏輯與輸出邏輯分離，大幅提升了代碼的可測試性和可維護性。

- ✅ 新增 `InningSummary` 類別封裝結果
- ✅ 新增 `getInningSummary()` 方法（可測試）
- ✅ 新增 `show()` 方法（輸出邏輯）
- ✅ 保留 `announceInning()` 方法（向後相容）
- ✅ 新增 7 個測試案例，全部通過
- ✅ 所有 118 個測試通過
